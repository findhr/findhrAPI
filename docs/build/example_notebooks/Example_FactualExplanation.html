
<!DOCTYPE html>

<html class="writer-html5" data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Factual Explanation of LambdaMART — findhrAPI 1.0.0 documentation</title>
<link href="../_static/pygments.css?v=b86133f3" rel="stylesheet" type="text/css"/>
<link href="../_static/css/theme.css?v=e59714d7" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css?v=b2176991" rel="stylesheet" type="text/css"/>
<link href="../_static/nbsphinx-code-cells.css?v=2aa19091" rel="stylesheet" type="text/css"/>
<script src="../_static/jquery.js?v=5d32c60e"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
<script src="../_static/documentation_options.js?v=f9c1cefe"></script>
<script src="../_static/doctools.js?v=9a2dae69"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
<script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="../_static/js/theme.js"></script>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../index.html">
            findhrAPI
          </a>
<div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input_data_format.html">Input Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocess.html">Feature Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fairness.html">Fairness Intervention for Fair Rankings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Fairness Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xai.html">eXplainable AI (XAI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../index.html">findhrAPI</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="../index.html"></a></li>
<li class="breadcrumb-item active">Factual Explanation of LambdaMART</li>
<li class="wy-breadcrumbs-aside">
<a href="../_sources/example_notebooks/Example_FactualExplanation.ipynb" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<section id="Factual-Explanation-of-LambdaMART">
<h1>Factual Explanation of LambdaMART<a class="headerlink" href="#Factual-Explanation-of-LambdaMART" title="Link to this heading"></a></h1>
<p>This notebook shows an example of how to use the APIs with the ExplainableBoostingMachine model from the <a class="reference external" href="https://interpret.ml/docs/ebm.html">interpret</a> package and how to get a factual explanation for the model in the form of feature importance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load and join raw data sources and their metadata.</span>
<span class="o">%</span><span class="k">run</span> Example_InputDataSources.ipynb
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Joined DataFrame.</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>id_c</th>
<th>education_background_c</th>
<th>professional_experience_c</th>
<th>skills_c</th>
<th>gender_c</th>
<th>agg_perceived_foreign_c</th>
<th>id_j</th>
<th>education_reqs_j</th>
<th>experience_reqs_role_j</th>
<th>experience_reqs_duration_j</th>
<th>skills_j</th>
<th>gender_j</th>
<th>agg_perceived_foreign_j</th>
<th>ranking</th>
<th>shortlisted</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>5</td>
<td>[{'institution': 'Complutense University Of Ma...</td>
<td>[{'institution': 'Stylo Milano', 'start_date':...</td>
<td>[Communications, Social Integration, Microsoft...</td>
<td>Man</td>
<td>No</td>
<td>5</td>
<td>[Law Bachelor, Degree In Law, Higher Degree In...</td>
<td>[Consultant]</td>
<td>12</td>
<td>[Punctuality, Organization, Accounting, Englis...</td>
<td>Man</td>
<td>No</td>
<td>4</td>
<td>1</td>
<td>0.0</td>
</tr>
<tr>
<th>1</th>
<td>6</td>
<td>[{'institution': 'Coronel Rosales Agricultural...</td>
<td>[{'institution': 'Securitas Direct', 'start_da...</td>
<td>[Refinancing, Economy, Microsoft Excel, Collec...</td>
<td>Man</td>
<td>No</td>
<td>3</td>
<td>[]</td>
<td>[Sales Assistant, Saleswoman, Commercial Advisor]</td>
<td>12</td>
<td>[English, Spanish, Communications, Communicati...</td>
<td>Man</td>
<td>No</td>
<td>8</td>
<td>1</td>
<td>0.6</td>
</tr>
<tr>
<th>2</th>
<td>10</td>
<td>[{'institution': 'Complutense University Of Ma...</td>
<td>[{'institution': 'Carrefour Express', 'start_d...</td>
<td>[Entrepreneurship, Literacy, Web Design, Adobe...</td>
<td>Woman</td>
<td>No</td>
<td>5</td>
<td>[Law Bachelor, Degree In Law, Higher Degree In...</td>
<td>[Consultant]</td>
<td>12</td>
<td>[Punctuality, Organization, Accounting, Englis...</td>
<td>Man</td>
<td>No</td>
<td>4</td>
<td>1</td>
<td>0.0</td>
</tr>
<tr>
<th>3</th>
<td>11</td>
<td>[{'institution': 'Les Ribera De Los Molinos', ...</td>
<td>[{'institution': 'Decimas Sl', 'start_date': '...</td>
<td>[Consulting, Sap Crm, Collections, Automation,...</td>
<td>Woman</td>
<td>No</td>
<td>3</td>
<td>[]</td>
<td>[Sales Assistant, Saleswoman, Commercial Advisor]</td>
<td>12</td>
<td>[English, Spanish, Communications, Communicati...</td>
<td>Man</td>
<td>No</td>
<td>12</td>
<td>0</td>
<td>0.4</td>
</tr>
<tr>
<th>4</th>
<td>15</td>
<td>[{'institution': 'Escuela Politcnica Superior ...</td>
<td>[{'institution': 'Reintegrate', 'start_date': ...</td>
<td>[Microsoft Word, Biofuels, English, Entreprene...</td>
<td>Man</td>
<td>No</td>
<td>3</td>
<td>[]</td>
<td>[Sales Assistant, Saleswoman, Commercial Advisor]</td>
<td>12</td>
<td>[English, Spanish, Communications, Communicati...</td>
<td>Man</td>
<td>No</td>
<td>5</td>
<td>1</td>
<td>0.7</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Joined metadata.</span>
<span class="n">md_all</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'id_c':
        SCHEMA = {'type': 'number'}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'education_background_c':
        SCHEMA = {'type': 'array', 'items': {'type': 'object', 'properties': {'institution': {'type': 'string'}, 'end_date': {'type': 'string'}, 'degree': {'type': 'string'}, 'duration': {'type': 'string'}}}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'professional_experience_c':
        SCHEMA = {'type': 'array', 'items': {'type': 'object', 'properties': {'institution': {'type': 'string'}, 'end_date': {'type': 'string'}, 'role': {'type': 'string'}, 'duration': {'type': 'string'}}}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'skills_c':
        SCHEMA = {'type': 'array', 'items': {'type': 'string'}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'gender_c':
        SCHEMA = {'enum': ['Man', 'Woman', 'Any']}
        ATTR_TYPE = category
        ATTR_USAGE = sensitive
        KNOWLEDGE_BASE = None,
 'agg_perceived_foreign_c':
        SCHEMA = {'enum': ['No', 'Yes', 'Any']}
        ATTR_TYPE = category
        ATTR_USAGE = sensitive
        KNOWLEDGE_BASE = None,
 'id_j':
        SCHEMA = {'type': 'number'}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'education_reqs_j':
        SCHEMA = {'type': 'array', 'items': {'type': 'string'}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'experience_reqs_role_j':
        SCHEMA = {'type': 'array', 'items': {'type': 'string'}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'experience_reqs_duration_j':
        SCHEMA = {'type': 'number'}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'skills_j':
        SCHEMA = {'type': 'array', 'items': {'type': 'string'}}
        ATTR_TYPE = object
        ATTR_USAGE = default
        KNOWLEDGE_BASE = None,
 'gender_j':
        SCHEMA = {'enum': ['Man', 'Woman', 'Any']}
        ATTR_TYPE = category
        ATTR_USAGE = sensitive
        KNOWLEDGE_BASE = None,
 'agg_perceived_foreign_j':
        SCHEMA = {'enum': ['No', 'Yes', 'Any']}
        ATTR_TYPE = category
        ATTR_USAGE = sensitive
        KNOWLEDGE_BASE = None,
 'score':
        SCHEMA = {'type': 'number'}
        ATTR_TYPE = numeric
        ATTR_USAGE = target
        KNOWLEDGE_BASE = None,
 'ranking':
        SCHEMA = {'type': 'integer'}
        ATTR_TYPE = ordinal
        ATTR_USAGE = target
        KNOWLEDGE_BASE = None,
 'shortlisted':
        SCHEMA = {'type': 'integer'}
        ATTR_TYPE = category
        ATTR_USAGE = target
        KNOWLEDGE_BASE = None}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#module-findhr.preprocess.example_mappings" title="findhr.preprocess.example_mappings"><span class="nn">findhr.preprocess.example_mappings</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.RelevantExperienceForRole" title="findhr.preprocess.example_mappings.RelevantExperienceForRole"><span class="n">RelevantExperienceForRole</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.ExtractMonthDurationJob" title="findhr.preprocess.example_mappings.ExtractMonthDurationJob"><span class="n">ExtractMonthDurationJob</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchOrdinal" title="findhr.preprocess.example_mappings.MatchOrdinal"><span class="n">MatchOrdinal</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.ExtractListOfProperty" title="findhr.preprocess.example_mappings.ExtractListOfProperty"><span class="n">ExtractListOfProperty</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchFeatureAtLeastInList" title="findhr.preprocess.example_mappings.MatchFeatureAtLeastInList"><span class="n">MatchFeatureAtLeastInList</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchFeatureSet" title="findhr.preprocess.example_mappings.MatchFeatureSet"><span class="n">MatchFeatureSet</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchBinary" title="findhr.preprocess.example_mappings.MatchBinary"><span class="n">MatchBinary</span></a>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#module-findhr.preprocess.mapping" title="findhr.preprocess.mapping"><span class="nn">findhr.preprocess.mapping</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.AttachMetadata" title="findhr.preprocess.mapping.AttachMetadata"><span class="n">AttachMetadata</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DetachMetadata" title="findhr.preprocess.mapping.DetachMetadata"><span class="n">DetachMetadata</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DerivedColumn" title="findhr.preprocess.mapping.DerivedColumn"><span class="n">DerivedColumn</span></a>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LGBMRanker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ndcg_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1"># Importing libraries to avoid warnings at running time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting category columns in DataFrame based on metadata.</span>
<span class="n">cat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">md_all</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">attr_type</span><span class="o">==</span><span class="s1">'category'</span><span class="p">]</span>
<span class="n">df_all</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="c1"># Dataframe metadata.</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1643 entries, 0 to 1642
Data columns (total 16 columns):
 #   Column                      Non-Null Count  Dtype
---  ------                      --------------  -----
 0   id_c                        1643 non-null   int64
 1   education_background_c      1643 non-null   object
 2   professional_experience_c   1643 non-null   object
 3   skills_c                    1643 non-null   object
 4   gender_c                    1643 non-null   category
 5   agg_perceived_foreign_c     1643 non-null   category
 6   id_j                        1643 non-null   int64
 7   education_reqs_j            1643 non-null   object
 8   experience_reqs_role_j      1643 non-null   object
 9   experience_reqs_duration_j  1643 non-null   int64
 10  skills_j                    1643 non-null   object
 11  gender_j                    1643 non-null   category
 12  agg_perceived_foreign_j     1643 non-null   category
 13  ranking                     1643 non-null   int64
 14  shortlisted                 1643 non-null   category
 15  score                       1643 non-null   float64
dtypes: category(5), float64(1), int64(4), object(6)
memory usage: 149.9+ KB
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define ids, target feature(s), and predictive features.</span>
<span class="n">id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'id_c'</span><span class="p">,</span> <span class="s1">'id_c'</span><span class="p">]</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'score'</span><span class="p">,</span> <span class="s1">'ranking'</span><span class="p">,</span> <span class="s1">'shortlisted'</span><span class="p">]</span>
<span class="n">pred_cols</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">target_cols</span> <span class="o">+</span> <span class="n">id_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For this example we assume that the training, validation and test set coincides</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_val</span> <span class="o">=</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">df_all</span>

<span class="n">df_train_counts</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"id_j"</span><span class="p">)[</span><span class="s2">"id_j"</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">df_val_counts</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"id_j"</span><span class="p">)[</span><span class="s2">"id_j"</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">df_train_counts</span><span class="p">,</span> <span class="n">df_val_counts</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([252, 734,  92, 423, 142]), array([252, 734,  92, 423, 142]))
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Build the preprocessing and prediction pipelines</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculated features.</span>
<span class="n">maps_derived_1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">((</span><span class="s1">'professional_experience_c'</span><span class="p">,</span> <span class="s1">'experience_reqs_role_j'</span><span class="p">,),</span> <span class="p">(</span><span class="s1">'relevant_exp_role_c'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.RelevantExperienceForRole" title="findhr.preprocess.example_mappings.RelevantExperienceForRole"><span class="n">RelevantExperienceForRole</span></a><span class="p">(),</span>
<span class="p">}</span>

<span class="n">maps_derived_2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">((</span><span class="s1">'relevant_exp_role_c'</span><span class="p">,),</span> <span class="p">(</span><span class="s1">'role_duration_months_c'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.ExtractMonthDurationJob" title="findhr.preprocess.example_mappings.ExtractMonthDurationJob"><span class="n">ExtractMonthDurationJob</span></a><span class="p">(</span><span class="n">duration_key</span><span class="o">=</span><span class="s1">'duration_months'</span><span class="p">),</span>
        <span class="p">((</span><span class="s1">'education_background_c'</span><span class="p">,),</span> <span class="p">(</span><span class="s1">'degree_list_c'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.ExtractListOfProperty" title="findhr.preprocess.example_mappings.ExtractListOfProperty"><span class="n">ExtractListOfProperty</span></a><span class="p">(</span><span class="n">property_key</span><span class="o">=</span><span class="s1">'degree'</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Fitness features about the matching between candidate's features and job's requirements.</span>
<span class="n">maps_matching</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">((</span><span class="s1">'experience_reqs_duration_j'</span><span class="p">,</span> <span class="s1">'role_duration_months_c'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'fitness_experience'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchOrdinal" title="findhr.preprocess.example_mappings.MatchOrdinal"><span class="n">MatchOrdinal</span></a><span class="p">(),</span>
    <span class="p">((</span><span class="s1">'education_reqs_j'</span><span class="p">,</span> <span class="s1">'education_background_c'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'fitness_education'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchFeatureAtLeastInList" title="findhr.preprocess.example_mappings.MatchFeatureAtLeastInList"><span class="n">MatchFeatureAtLeastInList</span></a><span class="p">(),</span>
    <span class="p">((</span><span class="s1">'skills_j'</span><span class="p">,</span> <span class="s1">'skills_c'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'fitness_skills'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchFeatureSet" title="findhr.preprocess.example_mappings.MatchFeatureSet"><span class="n">MatchFeatureSet</span></a><span class="p">(),</span>
    <span class="p">((</span><span class="s1">'gender_j'</span><span class="p">,</span> <span class="s1">'gender_c'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'fitness_gender'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchBinary" title="findhr.preprocess.example_mappings.MatchBinary"><span class="n">MatchBinary</span></a><span class="p">(),</span>
    <span class="p">((</span><span class="s1">'agg_perceived_foreign_j'</span><span class="p">,</span> <span class="s1">'agg_perceived_foreign_c'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'fitness_foreign'</span><span class="p">,)):</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.example_mappings.html#findhr.preprocess.example_mappings.MatchBinary" title="findhr.preprocess.example_mappings.MatchBinary"><span class="n">MatchBinary</span></a><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Helper variable for the fitness features</span>
<span class="n">list_cols_fitness</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'fitness_experience'</span><span class="p">,</span> <span class="s1">'fitness_education'</span><span class="p">,</span> <span class="s1">'fitness_skills'</span><span class="p">,</span> <span class="s1">'fitness_gender'</span><span class="p">,</span> <span class="s1">'fitness_foreign'</span><span class="p">]</span>
<span class="n">maps_matching</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(('experience_reqs_duration_j', 'role_duration_months_c'),
  ('fitness_experience',)): MatchOrdinal(),
 (('education_reqs_j', 'education_background_c'),
  ('fitness_education',)): MatchFeatureAtLeastInList(),
 (('skills_j', 'skills_c'), ('fitness_skills',)): MatchFeatureSet(),
 (('gender_j', 'gender_c'), ('fitness_gender',)): MatchBinary(),
 (('agg_perceived_foreign_j', 'agg_perceived_foreign_c'),
  ('fitness_foreign',)): MatchBinary()}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Scikit-learn transformation for numeric and categorical features</span>

<span class="n">numeric_features</span> <span class="o">=</span> <span class="n">list_cols_fitness</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gender_c'</span><span class="p">,</span> <span class="s1">'agg_perceived_foreign_c'</span><span class="p">]</span>
<span class="c1"># imputing and scaling numeric features</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"imputer"</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">"median"</span><span class="p">)),</span> <span class="c1"># Not needed for the used dataset.</span>
        <span class="p">(</span><span class="s2">"scaler"</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span> <span class="c1"># Not needed for the decision tree, let's keep it for the sake of generality.</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="c1"># imputing and encoding categorical features</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"imputer"</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">"most_frequent"</span><span class="p">)),</span> <span class="c1"># Not needed for the used dataset, again for the sake of generality.</span>
        <span class="p">(</span><span class="s2">"encoder"</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">()),</span> <span class="c1"># Convert to one-hot encoding</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="c1"># combining the two above</span>
<span class="n">column_preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"num"</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="c1"># ("cat", categorical_transformer, categorical_features)</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># The pipeline is composed of two phases:</span>
<span class="c1"># 1. Preprocessing with metadata (using findhr package)</span>
<span class="n">pipeline_derived</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s2">"init"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.AttachMetadata" title="findhr.preprocess.mapping.AttachMetadata"><span class="n">AttachMetadata</span></a><span class="p">(</span><span class="n">md_all</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">'mapping_1'</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DerivedColumn" title="findhr.preprocess.mapping.DerivedColumn"><span class="n">DerivedColumn</span></a><span class="p">(</span><span class="n">maps_derived_1</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">'mapping_2'</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DerivedColumn" title="findhr.preprocess.mapping.DerivedColumn"><span class="n">DerivedColumn</span></a><span class="p">(</span><span class="n">maps_derived_2</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">"matching"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DerivedColumn" title="findhr.preprocess.mapping.DerivedColumn"><span class="n">DerivedColumn</span></a><span class="p">(</span><span class="n">maps_matching</span><span class="p">)),</span>
    <span class="c1"># ("fitness", GroundTruthLinearWeightedScorer(gt_weights_fair)),</span>
    <span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.preprocess.mapping.html#findhr.preprocess.mapping.DetachMetadata" title="findhr.preprocess.mapping.DetachMetadata"><span class="n">DetachMetadata</span></a><span class="p">())</span>
<span class="p">])</span>
<span class="c1"># 2. Standard scikit-learn preprocessing to prepare the data for the model covered by column preprocessor.</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pipeline definition for regression model on the target feature "score".</span>
<span class="c1"># Note that LGBMRanker is not fully compatible with sklearn Pipeline</span>
<span class="c1"># https://github.com/microsoft/LightGBM/issues/5041#issuecomment-1054827692</span>

<span class="n">pipeline_rank</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># first phase: preprocessing with metadata</span>
        <span class="p">(</span><span class="s1">'fitness_value'</span><span class="p">,</span> <span class="n">pipeline_derived</span><span class="p">),</span>
        <span class="c1"># second phase: preprocessing without metadata (standard scikit-learn)</span>
        <span class="p">(</span><span class="s2">"column_preprocessor"</span><span class="p">,</span> <span class="n">column_preprocessor</span><span class="p">),</span>
        <span class="c1"># model inference</span>
        <span class="c1"># ("ranker", LGBMRanker( # Define the ranking model</span>
        <span class="c1">#     objective = "lambdarank",</span>
        <span class="c1">#     class_weight = "balanced",</span>
        <span class="c1">#     boosting_type = "gbdt",</span>
        <span class="c1">#     importance_type = "gain",</span>
        <span class="c1">#     learning_rate = 0.1,</span>
        <span class="c1">#     n_estimators = 10,</span>
        <span class="c1">#     force_row_wise = True,</span>
        <span class="c1">#     verbose = -1              # no verbosity</span>
        <span class="c1"># ))</span>
       <span class="p">]</span>
<span class="p">)</span>

<span class="n">ranker</span> <span class="o">=</span> <span class="n">LGBMRanker</span><span class="p">(</span> <span class="c1"># Define the ranking model</span>
            <span class="n">objective</span> <span class="o">=</span> <span class="s2">"lambdarank"</span><span class="p">,</span>
            <span class="n">class_weight</span> <span class="o">=</span> <span class="s2">"balanced"</span><span class="p">,</span>
            <span class="n">boosting_type</span> <span class="o">=</span> <span class="s2">"gbdt"</span><span class="p">,</span>
            <span class="n">importance_type</span> <span class="o">=</span> <span class="s2">"gain"</span><span class="p">,</span>
            <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">min_data_in_leaf</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">force_row_wise</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>           <span class="c1"># no verbosity during training, no warnings</span>
        <span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the top_K number for each job_id</span>
<span class="n">TOP_K</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># Helper function to transform the rank into relevance, to train the LGBMRanker through the ndcg_score</span>
<span class="c1"># LightGBM relevance is the higher the better</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rank2relevance</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># Convert the ranking col to a relevance scale from 0 to TOP_K</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">TOP_K</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">'ranking'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Note the first time we call the pipeline, it will fit the metadata and the transformations</span>
<span class="n">transformed_data</span> <span class="o">=</span> <span class="n">pipeline_rank</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pred_cols</span><span class="p">])</span>
<span class="n">transformed_val_data</span> <span class="o">=</span> <span class="n">pipeline_rank</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_val</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pred_cols</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fitting ranker:</span>
<span class="n">fitting_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">transformed_data</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span>  <span class="n">rank2relevance</span><span class="p">(</span><span class="n">df_train</span><span class="p">),</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">df_train_counts</span><span class="p">,</span>
    <span class="n">eval_at</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOP_K</span><span class="p">],</span>
    <span class="n">eval_set</span> <span class="o">=</span><span class="p">[(</span><span class="n">transformed_val_data</span><span class="p">,</span> <span class="n">rank2relevance</span><span class="p">(</span><span class="n">df_val</span><span class="p">))],</span>
    <span class="n">eval_group</span> <span class="o">=</span><span class="p">[</span><span class="n">df_val_counts</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ranker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fitting_params</span><span class="p">)</span>
<span class="c1"># pipeline_rank.fit(df_train.loc[:, pred_cols])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div class="sk-top-container" id="sk-container-id-1"><div class="sk-text-repr-fallback"><pre>LGBMRanker(class_weight='balanced', force_row_wise=True, importance_type='gain',
           min_data_in_leaf=10, n_estimators=10, objective='lambdarank',
           verbose=-1)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br/>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input checked="" class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"/><label class="sk-toggleable__label fitted sk-toggleable__label-arrow" for="sk-estimator-id-1"><div><div>LGBMRanker</div></div><div><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>LGBMRanker(class_weight='balanced', force_row_wise=True, importance_type='gain',
           min_data_in_leaf=10, n_estimators=10, objective='lambdarank',
           verbose=-1)</pre></div> </div></div></div></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model prediction.</span>
<span class="n">transformed_test_data</span> <span class="o">=</span> <span class="n">pipeline_rank</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pred_cols</span><span class="p">])</span>
<span class="n">lambda_pred</span> <span class="o">=</span> <span class="n">ranker</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">transformed_test_data</span><span class="p">)</span>
<span class="n">lambda_pred</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([-0.26667836, -0.75141939, -0.2615857 , ..., -0.26667836,
        0.12847777, -1.34759893], shape=(1643,))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show an example of the relevance for the test dataset</span>
<span class="n">test_relevance</span> <span class="o">=</span> <span class="n">rank2relevance</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_relevance</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test_relevance</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 7,  3,  7,  6,  7,  7,  7,  7,  7,  7,  7,  7,  3,  7,  7,  7,  7,
        8,  5,  7,  7,  3,  7,  7,  7,  7,  7,  7,  7,  6,  7,  5,  7,  7,
        5,  6,  1,  7,  7,  8,  8,  7,  7,  7,  3,  7,  7,  7,  7,  7, 10,
        7,  6,  9,  7,  5,  7,  7,  7,  7,  7,  1,  9,  1,  3,  1,  2,  2,
        2,  3,  2,  2,  2,  2,  2,  4,  2,  1,  1,  2,  1,  2,  2,  2,  2,
        2,  3,  2,  1,  1,  1,  4,  1,  2,  2,  2,  2,  2,  2,  2,  1,  1,
        1,  3,  3,  3,  2,  4,  2,  4,  2,  1,  1, 10,  2,  3,  3,  3,  1,
        2,  4,  1,  1,  1,  1,  1,  9,  1,  1,  1,  2,  2,  1,  2,  2,  3,
        3,  3,  2,  1,  2,  2,  1,  1,  3,  1,  1,  1,  1,  4,  1,  2,  2,
        3,  3,  2,  2,  2,  2,  2,  2,  2,  1,  1,  4,  4,  4,  1,  1,  5,
        3,  2,  2,  4,  7,  2,  2,  2,  2,  3,  3,  3,  2,  2,  2,  2,  2,
        8,  7,  7,  7,  8,  7,  2,  2,  1,  2,  1,  2,  3,  3,  2,  3,  4,
        1,  6,  7,  7,  8,  4,  4,  5,  1,  1,  1,  8,  9,  3,  4,  4,  4,
        3,  2,  2,  2,  1,  2,  5,  5,  5,  6,  6,  2,  2,  2,  9,  2,  6,
        5,  3,  1,  1,  1,  5,  8,  1,  3,  3,  3,  2,  2,  2,  2,  7,  1,
        5,  8,  1,  1,  1,  7,  2,  1,  1,  1,  3,  3,  3,  2,  8,  3,  5,
        2,  3,  2,  8,  9,  2,  8,  1,  8,  3,  9,  2,  7,  6,  1,  8,  3,
        6,  4,  7,  1,  3,  1,  1,  3,  1,  7,  7,  3,  2,  2,  1,  5,  9,
        4,  2,  2,  2,  1,  1,  7,  2,  8,  8,  8,  1,  8,  1,  1,  2,  6,
        5,  7,  1,  1,  6,  7,  1,  1,  1,  1,  6,  6,  6,  5,  8,  8,  8,
        8,  2,  5,  3,  2,  2,  2,  8,  5,  5,  6,  3,  3,  1,  8,  7,  3,
        3,  2,  2,  2,  2,  2,  2,  8,  8,  2,  2,  2,  1,  9,  9,  9,  2,
        2,  2,  1,  1,  1,  5,  5,  3,  3,  2,  8,  1,  4,  4,  1,  1,  4,
        4,  8,  3,  3,  3, 10,  2,  2,  7,  2,  4,  8,  8,  8,  7,  8,  7,
        8,  8,  8,  8,  8,  7,  8,  8,  8,  8,  8,  7,  8,  8,  8,  8,  8,
        7,  2,  9,  3,  3,  3,  9,  8,  9,  3,  1,  2,  4,  8,  2,  3,  3,
        7,  7,  1,  3,  2,  5,  1,  9,  8,  8,  2,  3,  2,  8,  1,  5,  3,
        2,  9,  3,  1,  3,  5,  8,  6,  1,  1,  4,  1,  1,  3,  1,  2,  1,
        1,  3,  3,  3,  1,  9,  5,  9,  7,  8,  8,  6,  4,  4,  9,  3,  1,
        1,  2,  4,  2,  8,  8,  2,  3,  3,  1,  9,  8,  3,  3,  4,  3,  2,
        7,  1,  1,  1,  7,  9,  8,  3,  8,  2,  1,  7,  4,  9,  3,  8,  3,
        3,  8,  8,  3,  3,  3,  2,  5,  3,  5,  8,  3,  1,  5,  3,  3,  3,
        8,  4,  5,  3,  3,  4,  5,  2,  4,  4,  1,  3,  2,  5,  3,  4,  3,
        5, 10,  2,  3,  9,  3,  2,  4,  3,  9,  8,  8,  8,  8,  3,  4,  3,
        8,  3,  3,  1, 10,  5,  2,  2,  1,  9,  7,  1,  2,  8,  2,  6,  1,
        9,  3,  1,  8,  5,  4,  3,  6,  7,  7,  1,  1,  6,  8,  3,  7,  7,
        1,  7,  8,  3,  3,  5,  9,  3,  2,  4,  2,  1,  6,  1,  8,  1,  2,
        5,  8,  1,  5,  4,  1,  1,  4,  4,  4,  6,  2,  1,  1,  4,  4,  7,
        1,  1,  1, 10,  4,  2])
</pre></div></div>
</div>
<section id="Model-validation">
<h2>Model validation<a class="headerlink" href="#Model-validation" title="Link to this heading"></a></h2>
<p>In this example, we do not have enough jobs to obtain proper train, validation and test data splits. Therefore, we validate the model by checking the relation between the “lambdas” predicted by the LGBMRanker model, and the score, separately for each job offer. To better understand the LambdaRank framework, we point to the relevant literature (e.g. <a class="reference external" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/MSR-TR-2010-82.pdf">Burges, 2010, From RankNet to LambdaRank to LambdaMART: An
Overview</a>)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">'lambda_pred'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda_pred</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We now show that there is a clear trend of correlation between the score and the predicted lambda from the models for each job_id</span>
<span class="c1"># Let's describe the prediction with a scatterplot</span>

<span class="c1"># Set plotting variables</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'Set1'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># export the unique ids for jobs</span>
<span class="n">unique_ids</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="s1">'id_j'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># Produce a plot for each unique job_id</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_all</span><span class="p">[</span><span class="s1">'id_j'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="n">df_all</span><span class="p">[</span><span class="s1">'id_j'</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span><span class="p">]</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">'lambda_pred'</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s1">'score'</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="c1"># If there is more than one data point, compute and plot the trendline.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">'lambda_pred'</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s1">'score'</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">'lambda_pred'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">subset</span><span class="p">[</span><span class="s1">'lambda_pred'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">y_vals</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Finalize plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'lambda_pred'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'score'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'id_j'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_Example_FactualExplanation_20_0.svg" src="../_images/example_notebooks_Example_FactualExplanation_20_0.svg"/></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndcg_score</span><span class="p">(</span><span class="n">rank2relevance</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ranker</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">transformed_test_data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.float64(0.9684121737647647)
</pre></div></div>
</div>
</section>
<section id="Example-Model-Explanation-with-RankingSHAP">
<h2>Example Model Explanation with RankingSHAP<a class="headerlink" href="#Example-Model-Explanation-with-RankingSHAP" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/findhr.xai.factual.ranking_shap.html#module-findhr.xai.factual.ranking_shap" title="findhr.xai.factual.ranking_shap"><span class="nn">findhr.xai.factual.ranking_shap</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.xai.factual.ranking_shap.html#findhr.xai.factual.ranking_shap.RankingShap" title="findhr.xai.factual.ranking_shap.RankingShap"><span class="n">RankingShap</span></a>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">kendalltau</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the background data</span>
<span class="c1"># we use the training data of the candidates applying for the job with id_j = 3</span>
<span class="n">background_data</span> <span class="o">=</span> <span class="n">pipeline_rank</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">'id_j'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">][</span><span class="n">pred_cols</span><span class="p">])</span>

<span class="c1"># Define the rank similarity coefficient for comparing the predicted ranking for explanations</span>
<span class="n">rank_similarity_coefficient</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">kendalltau</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># rank_similarity_coefficient = lambda x, y: ndcg_score(x.reshape(1, -1), y.reshape(1, -1), k=TOP_K)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="../generated/findhr.xai.factual.ranking_shap.html#findhr.xai.factual.ranking_shap.RankingShap" title="findhr.xai.factual.ranking_shap.RankingShap"><span class="n">ranking_shap_explainer</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.xai.factual.ranking_shap.html#findhr.xai.factual.ranking_shap.RankingShap" title="findhr.xai.factual.ranking_shap.RankingShap"><span class="n">RankingShap</span></a><span class="p">(</span>
    <span class="n">permutation_sampler</span><span class="o">=</span><span class="s2">"kernel"</span><span class="p">,</span>
    <span class="n">background_data</span><span class="o">=</span><span class="n">background_data</span><span class="p">,</span>
    <span class="n">original_model</span><span class="o">=</span><span class="n">ranker</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"rankingshap"</span><span class="p">,</span>
    <span class="n">rank_similarity_coefficient</span><span class="o">=</span><span class="n">rank_similarity_coefficient</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the explicand data</span>
<span class="n">explicand_data</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">df_train</span><span class="p">[</span><span class="s1">'id_j'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">][</span><span class="n">pred_cols</span><span class="p">]</span> <span class="c1">#df_train[pred_cols].iloc[200:210, :]</span>
<span class="c1"># Transform the explicand data</span>
<span class="n">transformed_explicand_data</span> <span class="o">=</span> <span class="n">pipeline_rank</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">explicand_data</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the explanation</span>
<span class="n">out_exp</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/findhr.xai.factual.ranking_shap.html#findhr.xai.factual.ranking_shap.RankingShap.get_query_explanation" title="findhr.xai.factual.ranking_shap.RankingShap.get_query_explanation"><span class="n">ranking_shap_explainer</span><span class="o">.</span><span class="n">get_query_explanation</span></a><span class="p">(</span><span class="n">transformed_explicand_data</span><span class="p">)</span>

<span class="c1"># Get the feature importance for the explicand data after renaming the features as fitness features</span>
<span class="n">out_exp_renamed</span> <span class="o">=</span> <span class="p">{</span><span class="n">list_cols_fitness</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out_exp</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">out_exp_renamed</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e6970b16771a4b3993b20c8fc09720ae"}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'fitness_skills': np.float64(0.4467164530491562),
 'fitness_experience': np.float64(0.42041501346794374),
 'fitness_foreign': np.float64(0.06408317580340259),
 'fitness_gender': np.float64(0.05932525256721888),
 'fitness_education': np.float64(0.009460105112278572)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The most important features are skills and experience. The others have low importance. In particular, the small values of importance are due to approximation errors</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the feature importance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">out_exp_renamed</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_exp_renamed</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Feature Importance'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, 'Feature Importance')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_Example_FactualExplanation_29_1.svg" src="../_images/example_notebooks_Example_FactualExplanation_29_1.svg"/></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {"0581b5a5a51c40b5b6f696d8de6e9c79": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "13c77df173844747968d1e5f0af77d3b": {"model_name": "ProgressStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "6ed8b4bbe83a4c41b48332f57f311963": {"model_name": "FloatProgressModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ProgressView", "bar_style": "success", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_0581b5a5a51c40b5b6f696d8de6e9c79", "max": 1.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_13c77df173844747968d1e5f0af77d3b", "tabbable": null, "tooltip": null, "value": 1.0}}, "53e08100ab3444aebeca0cbe071367bb": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "6839783c59ca4579b4d5839f4532e779": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "b693575135fc4c2d8be05596d79bb015": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_53e08100ab3444aebeca0cbe071367bb", "placeholder": "\u200b", "style": "IPY_MODEL_6839783c59ca4579b4d5839f4532e779", "tabbable": null, "tooltip": null, "value": "100%"}}, "be09ef39e52548a4966a55c3bbf244b5": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "ca7a909a57a54f8bab7cc8e2d4cf6926": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "6ba90aa2f7454d849ae6b20e25f175ce": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_be09ef39e52548a4966a55c3bbf244b5", "placeholder": "\u200b", "style": "IPY_MODEL_ca7a909a57a54f8bab7cc8e2d4cf6926", "tabbable": null, "tooltip": null, "value": "\u20071/1\u2007[00:01&lt;00:00,\u2007\u20071.23s/it]"}}, "c8e4f0ba05454d7eb77c33c28820794c": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e6970b16771a4b3993b20c8fc09720ae": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_b693575135fc4c2d8be05596d79bb015", "IPY_MODEL_6ed8b4bbe83a4c41b48332f57f311963", "IPY_MODEL_6ba90aa2f7454d849ae6b20e25f175ce"], "layout": "IPY_MODEL_c8e4f0ba05454d7eb77c33c28820794c", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}
</script></section>
</section>
</div>
</div>
<footer>
<hr/>
<div role="contentinfo">
<p>© Copyright 2024, findhr project.</p>
</div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
</div>
</div>
</section>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>